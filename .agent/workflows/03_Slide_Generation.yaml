name: "Slide Generation Pipeline"
description: >
  완성된 교안을 바탕으로 슬라이드를 기획하고 생성하는 시각화 단계 워크플로우 (11인 에이전트 팀).
  단일 파일 또는 폴더 지정 배치 모드를 지원합니다. 배치 모드 시 폴더 내 *.md 파일을
  동적으로 탐색하여 N개를 순차 처리합니다 (파일 수 가변).
  ⚠️ MUST ANALYZE CONTEXT: If a local folder is provided, analyze its contents
  using list_dir/read_file BEFORE proceeding.
version: "2.2"

output_path: "{YYYY-MM-DD_강의제목}/03_Slides/{session}/슬라이드기획안.md"
max_retries: 2  # step_10 반려 시 step_5부터 재실행 최대 횟수

logging:
  enabled: true
  protocol: ".agent/logging-protocol.md"
  model_config: ".opencode/oh-my-opencode.jsonc"
  path: ".agent/logs/{YYYY-MM-DD}_03_Slide_Generation.jsonl"
  format: "jsonl"
  # ── 로깅 강제 정책 (MANDATORY) ────────────────────────────────────────
  # A0 오케스트레이터는 각 step 실행 시 반드시 아래 훅을 실행합니다.
  # {step_id}, {agent}, {category}, {action}은 해당 step 정의에서 자동 치환됩니다.
  step_hooks:
    init: "RUN_ID=$(python3 .agent/scripts/agent_logger.py init --workflow 03_Slide_Generation)"
    pre_step: |
      python3 .agent/scripts/agent_logger.py start \
        --workflow 03_Slide_Generation --run-id $RUN_ID \
        --step-id {step_id} --agent {agent} --category {category} \
        --action {action}
    post_step: |
      python3 .agent/scripts/agent_logger.py end \
        --workflow 03_Slide_Generation --run-id $RUN_ID \
        --step-id {step_id} --output-bytes {output_bytes}
    on_fail: |
      python3 .agent/scripts/agent_logger.py fail \
        --workflow 03_Slide_Generation --run-id $RUN_ID \
        --step-id {step_id} --agent {agent} --category {category} \
        --action {action} --error "{error_message}"
    on_decision: |
      python3 .agent/scripts/agent_logger.py decision \
        --workflow 03_Slide_Generation --run-id $RUN_ID \
        --step-id {step_id} --agent {agent} --category {category} \
        --action {action} --decision {decision}
  enforcement: |
    ⚠️ 로깅은 step 실행의 전제조건입니다. 생략 시 QA에서 반려됩니다.
    - init: 파이프라인 최초 실행 시 1회 (RUN_ID 생성)
    - pre_step: 각 step 실행 직전 (START 기록)
    - post_step: 각 step 실행 직후 (END 기록)
    - on_fail/on_decision: 해당 이벤트 발생 시
    모든 step은 반드시 [pre_step → step 실행 → post_step] 3단계로 정확히 1회 실행합니다.
    DECISION 이벤트는 판정 기록만 수행하며 추가 post_step 또는 추가 END를 발생시키면 안 됩니다.

# ───────────────────────────────────────────────────────────
# 입력 정책 (Input Policy)
# ───────────────────────────────────────────────────────────
# [단일 파일 모드] 특정 교안 파일 1개를 지정하여 처리
# [배치 모드] 교안 폴더를 지정하면 *.md N개를 발견하여 순차 처리
#   - 파일 수: 가변 (1개 ~ 수십 개)
#   - 파일당 전체 파이프라인(Phase 1~4) 1회 실행
#   - 세션간 용어집 누적 참조로 일관성 유지
# ───────────────────────────────────────────────────────────

steps:
  # Phase 1: 분석 및 정규화
  - id: step_1_analysis
    agent: "03_visualizer/A1_Content_Analyst"
    action: "analyze_content"
    input: "Lecture Material (Markdown, 단일 파일 또는 배치 모드의 현재 파일), Output Language: Korean"
    output: "Content Inventory (IR)"

  - id: step_2_terminology
    agent: "03_visualizer/A2_Terminology_Manager"
    action: "extract_terms"
    depends_on: "step_1_analysis"
    input: "Content Inventory, Output Language: Korean"
    output: "Glossary & Prerequisite Map"

  # Phase 2: 설계
  - id: step_3_structure
    agent: "03_visualizer/A3_Slide_Architect"
    action: "design_sequence"
    depends_on: "step_2_terminology"
    input: "Content Inventory, Glossary, Output Language: Korean"
    output: "Slide Sequence Map"

  - id: step_4_design_system
    agent: "03_visualizer/A7_Visual_Design_Director"
    action: "define_style"
    depends_on: "step_3_structure"
    input: "Slide Sequence Map, Output Language: Korean"
    output: "Design Tokens & Style Guide"

  # Phase 3: 생성 및 검증
  # ┌─ step_5 (A4 Layout) ─→ step_7 (A8 Copy) ──┐
  # │                                              ├→ step_9 (A10 Trace)
  # └─ step_6 (A5 Code)  ─→ step_8 (A6 Lab)  ───┘
  # Note: step_5 ∥ step_6 만 진정한 병렬. step_7은 step_5 완료 후, step_8은 step_6 완료 후 순차 실행.
  - id: step_5_layout
    agent: "03_visualizer/A4_Layout_Designer"
    action: "create_layout"
    depends_on: "step_4_design_system"
    parallel_group: "phase3"
    input: "Slide Sequence Map, Design Tokens, Output Language: Korean"
    output: "Slide Layout Specs"

  - id: step_6_code_validation
    agent: "03_visualizer/A5_Code_Validator"
    action: "validate_code"
    depends_on: "step_1_analysis"
    parallel_group: "phase3"
    input: "Content Inventory (Code Blocks), Output Language: Korean"
    output: "Validated Code Blocks"

  - id: step_7_copy_editing
    agent: "03_visualizer/A8_Copy_Tone_Editor"
    action: "refine_text"
    depends_on: "step_5_layout"
    parallel_group: "phase3"
    input: "Slide Layout Specs, Output Language: Korean"
    output: "Refined Slide Copy"

  # Phase 3.5: 실습 재현성 (A5 + A3 산출물 필요)
  - id: step_8_lab_cards
    agent: "03_visualizer/A6_Lab_Reproducibility_Engineer"
    action: "create_lab_cards"
    depends_on:
      - "step_6_code_validation"
      - "step_3_structure"
    input: "Validated Code Blocks, Slide Sequence Map, Output Language: Korean"
    output: "Lab Cards & Troubleshooting Guide"

  # Phase 4: 품질 게이트
  - id: step_9_traceability
    agent: "03_visualizer/A10_Trace_Citation_Keeper"
    action: "verify_sources"
    depends_on:
      - "step_5_layout"
      - "step_7_copy_editing"
      - "step_8_lab_cards"
    input: "All Agent Outputs, Output Language: Korean"
    output: "Traceability Report"

  - id: step_10_final_qa
    agent: "03_visualizer/A9_QA_Auditor"
    action: "final_audit"
    depends_on: "step_9_traceability"
    input: "All Agent Outputs, Traceability Report, Output Language: Korean"
    decision:
      approved: "Finish — 산출물을 03_Slides/{session}/에 저장"
      rejected: "Go to step_5_layout (최대 2회 재실행)"
