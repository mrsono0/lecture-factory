name: "Manus Slide Generation Pipeline"
description: "04_SlidePrompt가 생성한 슬라이드 프롬프트를 교시 단위로 분할하여 Manus AI(Nano Banana Pro)에 제출하고, PPTX를 다운로드·병합하는 워크플로우 (6인 에이전트 팀). 대형 프롬프트(1000줄+)는 세션 경계에서 자동 분할되어 품질과 안정성을 확보합니다. ⚠️ MUST ANALYZE CONTEXT: If a local folder is provided, analyze its contents using list_dir/read_file BEFORE proceeding."
version: "1.1"
required_env:
  - MANUS_API_KEY

output_path: "{YYYY-MM-DD_강의제목}/07_ManusSlides/{세션ID}_{세션제목}.pptx"
max_retries: 2

logging:
  enabled: true
  protocol: ".agent/logging-protocol.md"
  path: ".agent/logs/{YYYY-MM-DD}_07_Manus_Slide.jsonl"
  format: "jsonl"

steps:
  # Phase 1: 입력 탐색 + 검증
  - id: step_1_input_discovery
    agent: "07_manus_slide/D0_Orchestrator"
    action: "discover_inputs"
    input: "04_SlidePrompt/ directory, MANUS_API_KEY, Output Language: Korean"
    output: "Input Manifest (prompt files list, sizes, slide counts)"
    description: "04_SlidePrompt/ 폴더에서 프롬프트 파일을 탐색하고, MANUS_API_KEY 유효성을 확인합니다. 파일별 줄 수·슬라이드 수를 집계하여 분할 필요 여부를 사전 판단합니다."

  - id: step_2_prompt_validation
    agent: "07_manus_slide/D1_Prompt_Validator"
    action: "validate_prompts"
    depends_on: "step_1_input_discovery"
    input: "Input Manifest, Prompt files, Output Language: Korean"
    output: "Validation Report (구조 검증, PREFIX 중복 체크, 섹션 완전성)"
    description: "각 프롬프트 파일의 6개 섹션(①~⑥) 구조 완전성을 검증합니다. SLIDE_GENERATION_PREFIX 중복 삽입 여부를 체크하고, Nano Banana Pro 디자인 규칙 준수를 확인합니다."

  # Phase 2: 교시 단위 분할
  - id: step_3_chunk_splitting
    agent: "07_manus_slide/D2_Chunk_Splitter"
    action: "split_prompts"
    depends_on: "step_2_prompt_validation"
    input: "Validated Prompt files, Validation Report, Output Language: Korean"
    output: "Chunk Manifest (분할 계획), Chunk files (임시 디렉토리)"
    description: "1000줄 이상 또는 35슬라이드 이상인 프롬프트를 교시(세션) 경계에서 분할합니다. 각 청크에 ①②④⑤ 공통 헤더를 복제하고, ③ 슬라이드 명세와 ⑥ 교안 원문을 대응하는 세션 단위로 추출합니다. 분할 불필요 파일은 원본 그대로 통과시킵니다."

  # Phase 3: Manus AI 제출 + 다운로드
  - id: step_4_manus_submission
    agent: "07_manus_slide/D3_Submission_Manager"
    action: "submit_and_download"
    depends_on: "step_3_chunk_splitting"
    input: "Chunk Manifest, Chunk files (or original files), MANUS_API_KEY, Output Language: Korean"
    output: "Submission Log, Downloaded PPTX files (07_ManusSlides/)"
    description: "manus_slide.py를 실행하여 각 청크(또는 원본)를 Manus AI에 순차 제출합니다. 30초 간격 폴링으로 완료를 감지하고, PPTX 파일을 07_ManusSlides/에 다운로드합니다. 실패 시 1회 자동 재시도합니다."

  # Phase 4: 후처리 + 품질 검증
  - id: step_5_post_processing
    agent: "07_manus_slide/D4_Post_Processor"
    action: "merge_and_cleanup"
    depends_on: "step_4_manus_submission"
    input: "Downloaded PPTX files, Chunk Manifest, Output Language: Korean"
    output: "Merged PPTX files (세션별 1개), Post-processing Report"
    description: "분할 제출된 청크 PPTX들을 python-pptx로 병합하여 세션별 단일 PPTX를 생성합니다. 헤더/풋터/페이지번호를 후처리 제거하고, 발표자 노트를 별도 마크다운으로 추출합니다. 비분할 파일은 후처리만 수행합니다."

  - id: step_6_visual_qa
    agent: "07_manus_slide/D5_Visual_QA"
    action: "inspect_quality"
    depends_on: "step_5_post_processing"
    input: "Final PPTX files, Chunk Manifest, Prompt files (원본 참조), Output Language: Korean"
    output: "QA Report (콘텐츠 보존율, 디자인 규칙 준수, 노트 완전성)"
    description: "최종 PPTX의 품질을 검사합니다: ① 콘텐츠 보존 (프롬프트 대비 슬라이드 수, 핵심 키워드 매칭), ② 디자인 규칙 (헤더/풋터 부재, full bleed), ③ 발표자 노트 완전성 (6개 필수 항목), ④ 청크 경계 자연스러움 (병합 슬라이드의 연속성)."

  - id: step_7_approval
    agent: "07_manus_slide/D0_Orchestrator"
    action: "review_and_decide"
    depends_on: "step_6_visual_qa"
    input: "QA Report, Post-processing Report, Output Language: Korean"
    output: "Final Decision (승인/재제출/반려)"
    decision:
      approved: "step_8_finalize"
      partial_resubmit: "step_4_manus_submission (해당 청크만 재제출)"
      rejected: "step_3_chunk_splitting (분할 전략 재실행, 최대 2회)"
    description: "QA 결과를 분석합니다. 품질 기준 충족 시 승인, 일부 청크만 문제 시 해당 청크만 재제출(step_4), 분할 전략 자체에 문제가 있으면 분할부터 재실행(step_3)합니다."

  # Phase 5: 최종 산출물
  - id: step_8_finalize
    agent: "07_manus_slide/D0_Orchestrator"
    action: "finalize_output"
    depends_on: "step_7_approval"
    input: "Approved PPTX files, QA Report, Submission Log, Output Language: Korean"
    output: "Final PPTX files, generation_report.json, manus_task_log.json"
    description: "최종 PPTX 파일 명명 규칙 적용({세션ID}_{세션제목}.pptx), 생성 리포트 작성(소요 시간, 분할/병합 이력, 재제출 횟수), 프로젝트 폴더 정리를 수행합니다."
