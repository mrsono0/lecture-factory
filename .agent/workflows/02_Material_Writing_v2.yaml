name: "Material Writing Pipeline v2 - Session-Based Aggregation"
description: "ë§ˆì´í¬ë¡œ ì„¸ì…˜ë³„ ê°œë³„ ì§‘í•„ í›„ ì·¨í•©í•˜ëŠ” Gemini ìµœì í™” êµì•ˆ ì‘ì„± ì›Œí¬í”Œë¡œìš° (Writer Team v2) âš ï¸ MUST ANALYZE CONTEXT: If a local folder is provided, analyze its contents using list_dir/read_file BEFORE proceeding."
version: "3.0"

output_path: "{YYYY-MM-DD_ê°•ì˜ì œëª©}/02_Material/ê°•ì˜êµì•ˆ_v1.0.md"
max_retries: 2

# â”€â”€ ì„¸ì…˜ ê¸°ë°˜ ì§‘í•„ ì •ì±… â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
session_writing_policy:
  enabled: true
  input_format: "micro_session_based"
  
  # ì…ë ¥ íŒŒì¼ ìœ„ì¹˜
  input_sources:
    session_specs: "01_Planning/micro_sessions/ì„¸ì…˜-*.md"
    session_index: "01_Planning/micro_sessions/_index.json"
    session_flow: "01_Planning/micro_sessions/_flow.md"
    dependency_graph: "01_Planning/micro_sessions/_dependency.mmd"
  
  # ì¶œë ¥ êµ¬ì¡°
  output_structure:
    individual_sessions: "02_Material/sessions/ì„¸ì…˜-{ë²ˆí˜¸:03d}-{ì œëª©}_v1.0.md"
    aggregated_material: "02_Material/ê°•ì˜êµì•ˆ_v1.0.md"
    visual_specs: "02_Material/visual_specs/"
    src_dir: "02_Material/src/"
  
  # Gemini ìµœì í™” ì„¤ì •
  gemini_optimized:
    chunk_size: "15-25min"
    estimated_chars: "3000-4500"
    min_chars_per_session: 3000
    max_chars_per_session: 4500
    writing_style: "continuous_prose"  # ê°œì¡°ì‹ ê¸ˆì§€, ì„œìˆ í˜• í•„ìˆ˜
    tone: "friendly_spoken_korean"   # ~í•´ìš”, ~ì…ë‹ˆë‹¤
    
  rules:
    - "ë‹¨ì¼ ì„¸ì…˜ ì§‘ì¤‘: ê° ì—ì´ì „íŠ¸ëŠ” 1ê°œì˜ ë§ˆì´í¬ë¡œ ì„¸ì…˜ë§Œ ì²˜ë¦¬"
    - "ê°œë³„ íŒŒì¼ ì¶œë ¥: ê° ì„¸ì…˜ì€ ë…ë¦½ëœ ì™„ì„±ëœ êµì•ˆ íŒŒì¼ë¡œ ì €ì¥"
    - "ì¶œë ¥ í•œê³„ ì¤€ìˆ˜: 3,000~4,500ì ë‚´ì—ì„œ ì™„ê²°ì„± í™•ë³´"
    - "ì„œìˆ í˜• ê°•ì œ: ê°œì¡°ì‹ ìš”ì•½ ê¸ˆì§€, ê¸´ ì¤„ê¸€ ì„œìˆ í˜• í•„ìˆ˜"
    - "ë¸Œë¦¿ì§€ ë…¸íŠ¸: ì„¸ì…˜ ê°„ ì—°ê²°ì„±ì„ ìœ„í•œ ì „í™˜ ë©˜íŠ¸ í¬í•¨"

logging:
  enabled: true
  protocol: ".agent/logging-protocol.md"
  model_config: ".opencode/oh-my-opencode.jsonc"
  path: ".agent/logs/{YYYY-MM-DD}_02_Material_Writing_v2.jsonl"
  format: "jsonl"

steps:
  # Phase 1: ì†ŒìŠ¤ ë¶„ì„ ë° êµ¬ì¡°í™” (ê¸°ì¡´ê³¼ ë™ì¼)
  - id: step_1_source_mining
    agent: "02_writer/A1_Source_Miner"
    action: "extract_facts"
    input: 
      - "Micro Session Specs (01_Planning/micro_sessions/)"
      - "Source Materials"
      - "NotebookLM URL (Optional)"
      - "Output Language: Korean"
    output: "Fact Packet"
    notes: |
      ğŸ“Š External Tool Logging: A1_Source_Miner must log all external tool calls
      (notebooklm, deep-research, context7, firecrawl, pdf-official) to
      .agent/logs/{DATE}_02_Material_Writing_v2.jsonl using EXTERNAL_TOOL_START/END events.

  - id: step_2_traceability_setup
    agent: "02_writer/A2_Traceability_Curator"
    action: "setup_tracking"
    depends_on: "step_1_source_mining"
    input: 
      - "Fact Packet"
      - "Source Materials"
      - "Output Language: Korean"
    output: "Traceability Packet (Initial)"

  - id: step_3_skeleton_design
    agent: "02_writer/A3_Curriculum_Architect"
    action: "create_skeleton"
    depends_on: "step_2_traceability_setup"
    input: 
      - "Fact Packet"
      - "Micro Session Index"
      - "Output Language: Korean"
    output: "Skeleton Packet (per session)"

  # Phase 2: ë§ˆì´í¬ë¡œ ì„¸ì…˜ë³„ ê°œë³„ ì§‘í•„ (Gemini ìµœì í™”)
  # NEW: A4Bê°€ ê° ë§ˆì´í¬ë¡œ ì„¸ì…˜ì„ ê°œë³„ì ìœ¼ë¡œ ì§‘í•„ (ë³‘ë ¬ ì‹¤í–‰)
  - id: step_4_session_writing
    agent: "02_writer/A4B_Session_Writer"
    action: "write_session_material"
    depends_on: "step_3_skeleton_design"
    parallel_mode: "foreach_session"  # ê° ë§ˆì´í¬ë¡œ ì„¸ì…˜ë³„ ë…ë¦½ ì‹¤í–‰
    batch_size: 3  # í•œ ë²ˆì— ì²˜ë¦¬í•  ì„¸ì…˜ ìˆ˜ (Gemini API rate limit ê³ ë ¤)
    input: 
      - "Session Spec (from 01_Planning)"
      - "Skeleton Packet"
      - "Fact Packet"
      - "Traceability Packet"
      - "Output Language: Korean"
    output: "Session Material Files (02_Material/sessions/ì„¸ì…˜-*.md)"
    notes: |
      ğŸ¯ í•µì‹¬: ê° ë§ˆì´í¬ë¡œ ì„¸ì…˜(15~25ë¶„)ì„ ê°œë³„ íŒŒì¼ë¡œ ì§‘í•„
      ğŸ“ ì¶œë ¥ ê·œì¹™:
        - ê³µë°± í¬í•¨ 3,000~4,500ì (Gemini ì¶œë ¥ í•œê³„ ì¤€ìˆ˜)
        - ì„œìˆ í˜• ê¸´ ì¤„ê¸€ (ê°œì¡°ì‹ ìš”ì•½ ê¸ˆì§€)
        - ì¹œê·¼í•œ êµ¬ì–´ì²´ (~í•´ìš”, ~ì…ë‹ˆë‹¤)
        - ğŸ—£ï¸ ê°•ì‚¬ ëŒ€ë³¸ + ğŸ™ï¸ ì‹¤ìŠµ ê°€ì´ë“œ í¬í•¨
        - ë¹„ìœ  ë° ìŠ¤í† ë¦¬í…”ë§ ('AI ì‹œëŒ€ì˜ ì„œì‚¬' í†¤)
      ğŸ“ ì‚°ì¶œë¬¼: 02_Material/sessions/ì„¸ì…˜-{ë²ˆí˜¸:03d}-{ì œëª©}_v1.0.md
      âš ï¸ ê° ì„¸ì…˜ì€ ë…ë¦½ì ìœ¼ë¡œ ì™„ê²°ì„±ì„ ê°€ì ¸ì•¼ í•¨ (ì¤‘ê°„ì— ëŠê¸°ì§€ ì•ŠìŒ)

  # Phase 3: ì‹œê°í™” ë° í‘œ ì„¤ê³„ (ë³‘ë ¬)
  - id: step_5_code_validation
    agent: "02_writer/A5_Code_Validator"
    action: "verify_code"
    depends_on: "step_4_session_writing"
    parallel_group: "phase3_enhancement"
    input: 
      - "Session Material Files"
      - "Output Language: Korean"
    output: "Verified Code Blocks & Tech Report"

  - id: step_6_visualization_design
    agent: "02_writer/A6_Visualization_Designer"
    action: "design_diagrams"
    depends_on: "step_4_session_writing"
    parallel_group: "phase3_enhancement"
    input: 
      - "Session Material Files"
      - "Fact Packet"
      - "Output Language: Korean"
    output: "Visualization Packet (Mermaid Diagrams)"

  # NEW: A11ì´ í‘œ ë° ì‹œê°í™” ëª…ì„¸ ì„¤ê³„
  - id: step_7_chart_specification
    agent: "02_writer/A11_Chart_Specifier"
    action: "design_tables"
    depends_on: "step_4_session_writing"
    parallel_group: "phase3_enhancement"
    input: 
      - "Session Material Files"
      - "chunk_type per session"
      - "Output Language: Korean"
    output: "Table & Chart Specifications (02_Material/visual_specs/)"
    notes: |
      ğŸ“Š í‘œ ì„¤ê³„: ë¹„êµ í‘œ, ìš”ì•½ í‘œ, ë‹¨ê³„ë³„ í‘œ
      ğŸ“ˆ ë‹¤ì´ì–´ê·¸ë¨: Mermaid flowchart, sequenceDiagram, classDiagram
      ğŸ¯ ì²­í¬ íƒ€ì…ë³„ ìµœì í™”: narrative/code/diagram/labë³„ ì ì ˆí•œ ì‹œê°í™”

  - id: step_8_learner_experience
    agent: "02_writer/A7_Learner_Experience_Designer"
    action: "design_labs"
    depends_on: "step_4_session_writing"
    parallel_group: "phase3_enhancement"
    input: 
      - "Session Material Files"
      - "Learner Persona"
      - "Output Language: Korean"
    output: "Lab Packet & Example Sets"

  - id: step_9_instructor_support
    agent: "02_writer/A9_Instructor_Support_Designer"
    action: "create_guide"
    depends_on: "step_4_session_writing"
    parallel_group: "phase3_enhancement"
    input: 
      - "Session Material Files"
      - "Lab Packet"
      - "Output Language: Korean"
    output: "Instructor Support Packet"

  - id: step_10_differentiation
    agent: "02_writer/A10_Differentiation_Strategist"
    action: "enhance_content"
    depends_on: "step_4_session_writing"
    parallel_group: "phase3_enhancement"
    input: 
      - "Session Material Files"
      - "Output Language: Korean"
    output: "Differentiation Strategy (USP) per session"

  # Phase 4: ì‹œê°í™” ì‚½ì… (ì„¸ì…˜ë³„)
  - id: step_11_visual_insertion
    agent: "02_writer/A4B_Session_Writer"
    action: "insert_visualizations"
    depends_on:
      - "step_6_visualization_design"
      - "step_7_chart_specification"
    input: 
      - "Session Material Files"
      - "Visualization Packet"
      - "Table Specifications"
      - "Output Language: Korean"
    output: "Enhanced Session Materials (with tables & diagrams)"

  # Phase 5: ì·¨í•© ë° í†µí•© (NEW)
  # NEW: A4Cê°€ ê°œë³„ ì„¸ì…˜ íŒŒì¼ë“¤ì„ ì·¨í•©í•˜ì—¬ ìµœì¢… êµì•ˆ ìƒì„±
  - id: step_12_aggregation
    agent: "02_writer/A4C_Material_Aggregator"
    action: "aggregate_sessions"
    depends_on:
      - "step_5_code_validation"
      - "step_11_visual_insertion"
      - "step_8_learner_experience"
      - "step_9_instructor_support"
      - "step_10_differentiation"
    input: 
      - "All Session Material Files"
      - "Session Index"
      - "Dependency Graph"
      - "Flow Document"
      - "Output Language: Korean"
    output: "Aggregated Material Draft (v1.0)"
    notes: |
      ğŸ¯ í•µì‹¬: ê°œë³„ ì„¸ì…˜ íŒŒì¼ë“¤ì„ ê²€ì¦í•˜ê³  í†µí•©
      ğŸ”— ì—°ê²°ì„± ê²€ì¦: ì˜ì¡´ì„± ê·¸ë˜í”„ ê¸°ë°˜ ì„¸ì…˜ ì—°ê²° í™•ì¸
      ğŸ“ ë¸Œë¦¿ì§€ ë…¸íŠ¸: ì„¸ì…˜ ê°„ ì „í™˜ ë©˜íŠ¸ ì‚½ì…
      ğŸ“‹ ìµœì¢… êµ¬ì¡°:
        - í—¤ë” ë° ë©”íƒ€ë°ì´í„°
        - ëª©ì°¨ ë° ë„¤ë¹„ê²Œì´ì…˜
        - ì˜ì¡´ì„± ê·¸ë˜í”„ (Mermaid)
        - ê°œë³„ ì„¸ì…˜ ë‚´ìš© í†µí•©
        - ë¶€ë¡ (ìš”ì•½, ì°¸ê³ ìë£Œ, ë¡œë“œë§µ)

  # Phase 6: ìµœì¢… QA
  - id: step_13_final_qa
    agent: "02_writer/A8_QA_Editor"
    action: "quality_assurance_v2"
    depends_on: "step_12_aggregation"
    input: 
      - "Aggregated Material (v1.0)"
      - "Fact Packet"
      - "Traceability Packet"
      - "Output Language: Korean"
    output: "QA Report & Final Material"
    qa_criteria:
      - "5ëŒ€ ì›ì¹™: ì™„ì „ì„±, ëª…í™•ì„±, ì¬í˜„ì„±, ì¶”ì ì„±, ì›ë³¸ìœ ì§€"
      - "ì„¸ì…˜ë³„ ë…ë¦½ì„± + ì „ì²´ ì¼ê´€ì„±"
      - "ë¸Œë¦¿ì§€ ë…¸íŠ¸ ì ì ˆì„±"
      - "ìš©ì–´ ë° ë¹„ìœ  ì¼ê´€ì„±"
      - "ë‚œì´ë„ ê³¡ì„  ë¶€ë“œëŸ¬ì›€"
      - "ì‹œê°í™” ì ì ˆì„± (í‘œ/ë‹¤ì´ì–´ê·¸ë¨)"
    decision:
      approved: "Finish"
      rejected: "Go to step_4_session_writing"

# â”€â”€ ëª¨ë¸ ë¼ìš°íŒ… ì„¤ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
model_routing:
  # ì„¸ì…˜ë³„ ì§‘í•„: Gemini 3.1 Pro (1M context, ê¸´ êµì•ˆ ì‘ì„±ì— ìµœì )
  A4B_Session_Writer:
    category: "micro-writing"
    note: "ë‹¨ì¼ ë§ˆì´í¬ë¡œ ì„¸ì…˜(3,000~4,500ì) ì§‘í•„ - Gemini 3.1 Pro ì‚¬ìš©"
  
  # ì·¨í•© ë° í†µí•©: Gemini 3.1 Pro (ì˜ì¡´ì„± ë¶„ì„ ë° í†µí•©)
  A4C_Material_Aggregator:
    category: "micro-writing"
    note: "ì„¸ì…˜ ì·¨í•© ë° ë¸Œë¦¿ì§€ ë…¸íŠ¸ ì‚½ì… - Gemini 3.1 Pro ì‚¬ìš©"
  
  # í‘œ ë° ì‹œê°í™”: visual-engineering ì¹´í…Œê³ ë¦¬
  A11_Chart_Specifier:
    category: "visual-engineering"
    note: "í‘œ ë° Mermaid ë‹¤ì´ì–´ê·¸ë¨ ì„¤ê³„"
  
  # ê¸°ì¡´ ì—ì´ì „íŠ¸ëŠ” ê¸°ë³¸ ì¹´í…Œê³ ë¦¬ ìœ ì§€
  A6_Visualization_Designer:
    category: "visual-engineering"
    note: "ì‹œê°í™” ì„¤ê³„ (ê¸°ì¡´ ì„¤ì • ìœ ì§€)"
  
  A8_QA_Editor:
    category: "ultrabrain"
    note: "ìµœì¢… QA (ê¸°ì¡´ ì„¤ì • ìœ ì§€)"

# â”€â”€ ì—…ìŠ¤íŠ¸ë¦¼/ë‹¤ìš´ìŠ¤íŠ¸ë¦¼ ì—°ë™ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
upstream_integration:
  # 01_Lecture_Planning_v2 ì—°ë™
  lecture_planning:
    required_inputs:
      - "01_Planning/micro_sessions/ì„¸ì…˜-*.md"
      - "01_Planning/micro_sessions/_index.json"
      - "01_Planning/micro_sessions/_flow.md"
      - "01_Planning/micro_sessions/_dependency.mmd"
    notes: |
      v2 ì›Œí¬í”Œë¡œìš°ëŠ” ë§ˆì´í¬ë¡œ ì„¸ì…˜ë³„ ê°œë³„ íŒŒì¼ì„ ì…ë ¥ìœ¼ë¡œ ë°›ìŒ.
      ê° ì„¸ì…˜ íŒŒì¼ì€ ë…ë¦½ì ìœ¼ë¡œ ì²˜ë¦¬ë˜ë©°, A4Cê°€ ìµœì¢… í†µí•©.

downstream_integration:
  # 03_Visualizer ì—°ë™
  visualizer:
    input_format: "session_based"
    session_files: "02_Material/sessions/ì„¸ì…˜-*.md"
    aggregated_material: "02_Material/ê°•ì˜êµì•ˆ_v1.0.md"
    
  # 04_Prompt_Generator ì—°ë™
  prompt_generator:
    input_format: "session_based"
    notes: |
      ìŠ¬ë¼ì´ë“œ í”„ë¡¬í”„íŠ¸ ìƒì„± ì‹œ ë§ˆì´í¬ë¡œ ì„¸ì…˜ë³„ë¡œ ê°œë³„ í”„ë¡¬í”„íŠ¸ íŒŒì¼ ìƒì„±.
