name: "Lecture Planning Pipeline"
description: "ê°•ì˜ ê¸°íš ì›Œí¬í”Œë¡œìš° (Planner Team) âš ï¸ MUST ANALYZE CONTEXT: If a local folder is provided, analyze its contents using list_dir/read_file BEFORE proceeding."
version: "3.0"

output_path: "{YYYY-MM-DD_ê°•ì˜ì œëª©}/01_Planning/ê°•ì˜êµ¬ì„±ì•ˆ.md"
max_retries: 2  # step_7 ë°˜ë ¤ ì‹œ step_3ë¶€í„° ì¬ì‹¤í–‰ ìµœëŒ€ íšŸìˆ˜

logging:
  enabled: true
  protocol: ".agent/logging-protocol.md"
  model_config: ".opencode/oh-my-opencode.jsonc"
  path: ".agent/logs/{YYYY-MM-DD}_01_Lecture_Planning.jsonl"
  format: "jsonl"
  # â”€â”€ ë¡œê¹… ê°•ì œ ì •ì±… (MANDATORY) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # A0 ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°ëŠ” ê° step ì‹¤í–‰ ì‹œ ë°˜ë“œì‹œ ì•„ë˜ í›…ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
  # {step_id}, {agent}, {category}, {action}ì€ í•´ë‹¹ step ì •ì˜ì—ì„œ ìë™ ì¹˜í™˜ë©ë‹ˆë‹¤.
  step_hooks:
    init: "RUN_ID=$(python3 .agent/scripts/agent_logger.py init --workflow 01_Lecture_Planning)"
    pre_step: |
      python3 .agent/scripts/agent_logger.py start \
        --workflow 01_Lecture_Planning --run-id $RUN_ID \
        --step-id {step_id} --agent {agent} --category {category} \
        --action {action}
    post_step: |
      python3 .agent/scripts/agent_logger.py end \
        --workflow 01_Lecture_Planning --run-id $RUN_ID \
        --step-id {step_id} --output-bytes {output_bytes}
    on_fail: |
      python3 .agent/scripts/agent_logger.py fail \
        --workflow 01_Lecture_Planning --run-id $RUN_ID \
        --step-id {step_id} --agent {agent} --category {category} \
        --action {action} --error "{error_message}"
    on_decision: |
      python3 .agent/scripts/agent_logger.py decision \
        --workflow 01_Lecture_Planning --run-id $RUN_ID \
        --step-id {step_id} --agent {agent} --category {category} \
        --action {action} --decision {decision}
  enforcement: |
    âš ï¸ ë¡œê¹…ì€ step ì‹¤í–‰ì˜ ì „ì œì¡°ê±´ì…ë‹ˆë‹¤. ìƒëµ ì‹œ A5A QAì—ì„œ ë°˜ë ¤ë©ë‹ˆë‹¤.
    - init: íŒŒì´í”„ë¼ì¸ ìµœì´ˆ ì‹¤í–‰ ì‹œ 1íšŒ (RUN_ID ìƒì„±)
    - pre_step: ê° step ì‹¤í–‰ ì§ì „ (START ê¸°ë¡)
    - post_step: ê° step ì‹¤í–‰ ì§í›„ (END ê¸°ë¡)
    - on_fail/on_decision: í•´ë‹¹ ì´ë²¤íŠ¸ ë°œìƒ ì‹œ
    ëª¨ë“  stepì€ ë°˜ë“œì‹œ [pre_step â†’ step ì‹¤í–‰ â†’ post_step] 3ë‹¨ê³„ë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤.

# ëª¨ë¸ ë¼ìš°íŒ…: .agent/agents/01_planner/config.json ì°¸ì¡°

steps:
  # Phase 1: ìˆœì°¨ ì‹¤í–‰ â€” ìŠ¤ì½”í”„ ì •ì˜ â†’ íŠ¸ë Œë“œ ë¦¬ì„œì¹˜ â†’ í•™ìŠµì ë¶„ì„ â†’ ì»¤ë¦¬í˜ëŸ¼ ì„¤ê³„
  
  # âš ï¸ Note on NotebookLM Execution (Critical)
  # Step 1 (A1_Trend_Researcher) requires NotebookLM URL execution.
  # Due to subagent limitations (skill() tool not accessible), the NotebookLM 
  # queries should be executed by the Main Agent before delegating to A1, 
  # OR A1 must use bash() tool to execute commands directly.
  # See: .agent/agents/01_planner/A1_Trend_Researcher.md Â§ğŸ”´ CRITICAL
  - id: step_0_scope
    agent: "01_planner/A0_Orchestrator"
    action: "analyze_request"
    input: "User Prompt, Lecture Topic File, NotebookLM URL (Optional), Output Language: Korean"
    output: "Scope Definition & Agent Task Beliefs"
    notes: |
      ì‚¬ìš©ì ìš”ì²­ì„ ë¶„ì„í•˜ì—¬ ìŠ¤ì½”í”„ë¥¼ ì •ì˜í•˜ê³  ì—ì´ì „íŠ¸ ì‘ì—…ì„ ë¶„ë°°í•©ë‹ˆë‹¤.

  - id: step_1_trend_analysis
    agent: "01_planner/A1_Trend_Researcher"
    action: "research_trend"
    depends_on: "step_0_scope"
    input: "Scope Definition, Output Language: Korean"
    output: "Trend Report & Fact Packet (01_Planning/Trend_Report.md)"
    notes: |
      âš ï¸ NotebookLM Execution: A1 must execute bash commands to run notebooklm queries.
      Verification: Check Trend_Report.md contains "Query 1/2/3" with actual stdout.
      On Failure: A0 must reject and retry step_1_trend_analysis (see A0_Orchestrator.md Â§ğŸ”´ A1 ê²€ì¦ í”„ë¡œí† ì½œ)
      ğŸ“Š External Tool Logging: A1 must log each NotebookLM query to .agent/logs/{DATE}_01_Lecture_Planning.jsonl using EXTERNAL_TOOL_START/END events (see logging-protocol.md Â§9.7)

  - id: step_2_learner_analysis
    agent: "01_planner/A5B_Learner_Analyst"
    action: "analyze_learner"
    depends_on: "step_1_trend_analysis"
    input: "Scope Definition, Trend Report, Output Language: Korean"
    output: "Learner Persona & Pain Points (01_Planning/ê°•ì˜êµ¬ì„±ì•ˆ.md ë‚´ í•™ìŠµì ë¶„ì„ ì„¹ì…˜)"

  - id: step_3_curriculum_design
    agent: "01_planner/A3_Curriculum_Architect"
    action: "design_structure"
    depends_on: "step_2_learner_analysis"
    input: "Learner Persona, Scope Definition, Trend Report, Output Language: Korean"
    output: "Curriculum Structure Draft (01_Planning/ê°•ì˜êµ¬ì„±ì•ˆ.md ì´ˆì•ˆ)"
    notes: |
      60~90ë¶„ ë‹¨ìœ„ ì„¸ì…˜ìœ¼ë¡œ ì»¤ë¦¬í˜ëŸ¼ ì´ˆì•ˆ ì„¤ê³„.
      âš ï¸ ë°˜ë“œì‹œ 01_Planning/ê°•ì˜êµ¬ì„±ì•ˆ.md íŒŒì¼ë¡œ ì €ì¥í•  ê²ƒ (step_2ì˜ í•™ìŠµì ë¶„ì„ ì„¹ì…˜ ìœ ì§€).
      ì´ ì´ˆì•ˆì€ step_4, step_5ì˜ ë³‘ë ¬ ì‘ì—… í›„ step_6ì—ì„œ í†µí•©ë©ë‹ˆë‹¤.

  # Phase 2: ë³‘ë ¬ ì‹¤í–‰ â€” A2ì™€ A7ì€ ì„œë¡œ ì˜ì¡´ì„± ì—†ì´ ë™ì‹œ ì‹¤í–‰ ê°€ëŠ¥
  - id: step_4_instructional_design
    agent: "01_planner/A2_Instructional_Designer"
    action: "design_activities"
    parallel: true  # â† A7ê³¼ ë³‘ë ¬ ì‹¤í–‰
    depends_on: "step_3_curriculum_design"
    input: 
      - "Curriculum Structure"
      - "Learner Persona"
      - "Output Language: Korean"
    output: "Learning Activities & Assessment Plan (01_Planning/ê°•ì˜êµ¬ì„±ì•ˆ.md ë‚´ í™œë™ ì„¹ì…˜)"
    notes: |
      ê° ì„¸ì…˜ë³„ í•™ìŠµ í™œë™ ì„¤ê³„.

  - id: step_5_differentiation
    agent: "01_planner/A7_Differentiation_Advisor"
    action: "identify_usp"
    parallel: true  # â† A2ì™€ ë³‘ë ¬ ì‹¤í–‰
    depends_on: "step_3_curriculum_design"
    input: 
      - "Curriculum Structure"
      - "Trend Report"
      - "Output Language: Korean"
    output: "Differentiation Strategy (USP) per session"

  # Phase 3: í†µí•© â€” A3ê°€ A2+A7 ì‚°ì¶œë¬¼ì„ ì»¤ë¦¬í˜ëŸ¼ì— ë³‘í•©
  - id: step_6_integration
    agent: "01_planner/A3_Curriculum_Architect"
    action: "integrate_outputs"
    depends_on:
      - "step_4_instructional_design"
      - "step_5_differentiation"
    input: 
      - "Curriculum Structure (Skeleton)"
      - "Learning Activities (A2)"
      - "Differentiation Strategy (A7)"
      - "Output Language: Korean"
    output: "Integrated Curriculum Plan (Complete)"
    notes: |
      A2, A7 ì‚°ì¶œë¬¼ì„ ì»¤ë¦¬í˜ëŸ¼ ì´ˆì•ˆì— í†µí•©í•˜ì—¬ ìµœì¢… ê°•ì˜êµ¬ì„±ì•ˆ ì™„ì„±.

  # Phase 4: QA â€” í†µí•©ëœ ì»¤ë¦¬í˜ëŸ¼ ê²€ì¦
  - id: step_7_qa_review
    agent: "01_planner/A5A_QA_Manager"
    action: "verify_plan"
    depends_on: "step_6_integration"
    input: 
      - "Integrated Curriculum Plan"
      - "Output Language: Korean"
    output: "QA Report & Final Curriculum Plan"
    qa_criteria:
      - "ì„¸ì…˜ë³„ í•™ìŠµ ëª©í‘œ ì •ë ¬ ì—¬ë¶€"
      - "ì‹œê°„ ì´í•© ì •í•©ì„±"
      - "ì„¸ì…˜ ê°„ ë…¼ë¦¬ì  ì—°ê²°ì„±"
      - "ìš©ì–´/í¬ë§· ì¼ê´€ì„±"
      - "ì™„ê²°ì„± (ì™¸ë¶€ ì˜ì¡´ ì—†ì´ êµì•ˆ ì‘ì„± ê°€ëŠ¥ ì—¬ë¶€)"
    notes: |
      í†µí•© ì»¤ë¦¬í˜ëŸ¼ì˜ í’ˆì§ˆ ê²€ì¦:
      1. ê° ì„¸ì…˜ì˜ í•™ìŠµ ëª©í‘œê°€ ì „ì²´ ëª©í‘œì™€ ì •ë ¬ë˜ëŠ”ê°€?
      2. ì‹œê°„ ë°°ë¶„ì´ ì ì ˆí•œê°€?
      3. ì„¸ì…˜ ê°„ ë…¼ë¦¬ì  íë¦„ì´ ìì—°ìŠ¤ëŸ¬ìš´ê°€?

  # Phase 5: ìµœì¢… ìŠ¹ì¸/ë°˜ë ¤
  - id: step_8_final_approval
    agent: "01_planner/A0_Orchestrator"
    action: "approve_deliverable"
    depends_on: "step_7_qa_review"
    input: 
      - "Final Curriculum Plan"
      - "QA Report"
      - "Output Language: Korean"
    output: "Approved Lecture Plan"
    decision:
      approved: 
        action: "Finish"
        save_targets:
          - "01_Planning/ê°•ì˜êµ¬ì„±ì•ˆ.md"
          - "01_Planning/Trend_Report.md"
      rejected: 
        action: "Retry from step_3_curriculum_design"
        max_retries: 2

# â”€â”€ ë‹¤ìš´ìŠ¤íŠ¸ë¦¼ ì—°ë™ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
downstream_integration:
  # 02_Material_Writing ì—°ë™
  material_writing:
    input_format: "session_based"
    plan_file: "01_Planning/ê°•ì˜êµ¬ì„±ì•ˆ.md"
    notes: |
      02_Material_Writingì€ ê°•ì˜êµ¬ì„±ì•ˆ.md ê¸°ë°˜ìœ¼ë¡œ ì„¸ì…˜ë³„ êµì•ˆì„ ì‘ì„±í•©ë‹ˆë‹¤.
